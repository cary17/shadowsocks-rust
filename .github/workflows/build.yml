  build-pure-tags:
    needs: [check-version, build-images]
    if: needs.check-version.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.GHCR_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Check Docker Hub credentials
        id: dockerhub
        run: |
          if [ -n "${{ secrets.DOCKERHUB_USERNAME }}" ] && [ -n "${{ secrets.DOCKERHUB_TOKEN }}" ]; then
            echo "enabled=true" >> $GITHUB_OUTPUT
          else
            echo "enabled=false" >> $GITHUB_OUTPUT
          fi

      - name: Log in to Docker Hub
        if: steps.dockerhub.outputs.enabled == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Prepare pure latest tags
        id: prepare-pure
        run: |
          VERSION="${{ needs.check-version.outputs.new_version }}"
          
          echo "Preparing pure latest tags for version: $VERSION"
          echo ""
          echo "Will build the following pure latest tags (each as a separate image with only 'latest' tag):"
          echo "=========================================================================================="
          echo ""
          echo "GHCR:"
          echo "  1. ${{ env.GHCR_IMAGE_BASE }}/shadowsocks-rust:latest (server-debian)"
          echo "  2. ${{ env.GHCR_IMAGE_BASE }}/ssserver-rust:latest (server-debian)"
          echo "  3. ${{ env.GHCR_IMAGE_BASE }}/sslocal-rust:latest (client-debian)"
          
          if [ "${{ steps.dockerhub.outputs.enabled }}" = "true" ]; then
            echo ""
            echo "Docker Hub:"
            echo "  1. ${{ secrets.DOCKERHUB_USERNAME }}/shadowsocks-rust:latest (server-debian)"
            echo "  2. ${{ secrets.DOCKERHUB_USERNAME }}/ssserver-rust:latest (server-debian)"
            echo "  3. ${{ secrets.DOCKERHUB_USERNAME }}/sslocal-rust:latest (client-debian)"
          fi
          
          # 存储信息供后续步骤使用
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Build and push pure latest tags - shadowsocks-rust:latest (server)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.debian
          platforms: linux/amd64,linux/arm64,linux/arm/v7
          push: true
          tags: |
            ${{ env.GHCR_IMAGE_BASE }}/shadowsocks-rust:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/shadowsocks-rust:latest
          build-args: |
            VERSION=${{ needs.check-version.outputs.new_version }}
            ACTIONS_TOKEN=${{ secrets.ACTIONS_TOKEN }}
            DEBIAN_VERSION=${{ github.event.inputs.debian_version || '13' }}
          cache-from: type=gha,scope=pure-shadowsocks-latest
          cache-to: type=gha,mode=max,scope=pure-shadowsocks-latest
          target: server
        continue-on-error: true

      - name: Build and push pure latest tags - ssserver-rust:latest (server)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.debian
          platforms: linux/amd64,linux/arm64,linux/arm/v7
          push: true
          tags: |
            ${{ env.GHCR_IMAGE_BASE }}/ssserver-rust:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/ssserver-rust:latest
          build-args: |
            VERSION=${{ needs.check-version.outputs.new_version }}
            ACTIONS_TOKEN=${{ secrets.ACTIONS_TOKEN }}
            DEBIAN_VERSION=${{ github.event.inputs.debian_version || '13' }}
          cache-from: type=gha,scope=pure-ssserver-latest
          cache-to: type=gha,mode=max,scope=pure-ssserver-latest
          target: server
        continue-on-error: true

      - name: Build and push pure latest tags - sslocal-rust:latest (client)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.debian
          platforms: linux/amd64,linux/arm64,linux/arm/v7
          push: true
          tags: |
            ${{ env.GHCR_IMAGE_BASE }}/sslocal-rust:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/sslocal-rust:latest
          build-args: |
            VERSION=${{ needs.check-version.outputs.new_version }}
            ACTIONS_TOKEN=${{ secrets.ACTIONS_TOKEN }}
            DEBIAN_VERSION=${{ github.event.inputs.debian_version || '13' }}
          cache-from: type=gha,scope=pure-sslocal-latest
          cache-to: type=gha,mode=max,scope=pure-sslocal-latest
          target: client
        continue-on-error: true

      - name: Verify pure latest tags were pushed
        run: |
          echo "Verifying all pure latest tags were pushed successfully..."
          echo ""
          
          VERSION="${{ needs.check-version.outputs.new_version }}"
          
          # 检查 GHCR 的所有纯 latest 标签
          echo "Checking GHCR pure latest tags:"
          echo "================================"
          
          GHCR_TAGS=(
            "${{ env.GHCR_IMAGE_BASE }}/shadowsocks-rust:latest"
            "${{ env.GHCR_IMAGE_BASE }}/ssserver-rust:latest"
            "${{ env.GHCR_IMAGE_BASE }}/sslocal-rust:latest"
          )
          
          for i in "${!GHCR_TAGS[@]}"; do
            TAG="${GHCR_TAGS[$i]}"
            echo -n "$((i+1)). $TAG... "
            docker buildx imagetools inspect "$TAG" >/dev/null 2>&1
            if [ $? -eq 0 ]; then
              echo "✓ OK"
            else
              echo "✗ FAILED"
            fi
          done
          
          # 检查 Docker Hub 的所有纯 latest 标签（如果启用）
          if [ "${{ steps.dockerhub.outputs.enabled }}" = "true" ]; then
            echo ""
            echo "Checking Docker Hub pure latest tags:"
            echo "======================================"
            
            DOCKERHUB_TAGS=(
              "${{ secrets.DOCKERHUB_USERNAME }}/shadowsocks-rust:latest"
              "${{ secrets.DOCKERHUB_USERNAME }}/ssserver-rust:latest"
              "${{ secrets.DOCKERHUB_USERNAME }}/sslocal-rust:latest"
            )
            
            for i in "${!DOCKERHUB_TAGS[@]}"; do
              TAG="${DOCKERHUB_TAGS[$i]}"
              echo -n "$((i+1)). $TAG... "
              docker buildx imagetools inspect "$TAG" >/dev/null 2>&1
              if [ $? -eq 0 ]; then
                echo "✓ OK"
              else
                echo "✗ FAILED"
              fi
            done
          fi
          
          echo ""
          echo "Summary of pure latest tags pushed:"
          echo "==================================="
          echo "These are separate images with only 'latest' tag:"
          echo ""
          echo "GHCR:"
          echo "  1. ${{ env.GHCR_IMAGE_BASE }}/shadowsocks-rust:latest (server-debian)"
          echo "  2. ${{ env.GHCR_IMAGE_BASE }}/ssserver-rust:latest (server-debian)"
          echo "  3. ${{ env.GHCR_IMAGE_BASE }}/sslocal-rust:latest (client-debian)"
          
          if [ "${{ steps.dockerhub.outputs.enabled }}" = "true" ]; then
            echo ""
            echo "Docker Hub:"
            echo "  1. ${{ secrets.DOCKERHUB_USERNAME }}/shadowsocks-rust:latest (server-debian)"
            echo "  2. ${{ secrets.DOCKERHUB_USERNAME }}/ssserver-rust:latest (server-debian)"
            echo "  3. ${{ secrets.DOCKERHUB_USERNAME }}/sslocal-rust:latest (client-debian)"
          fi
