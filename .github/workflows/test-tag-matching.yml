name: Test Tag Matching

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to test (e.g., v1.24.0)'
        required: true
        default: 'v1.24.0'
      repo:
        description: 'Repository to test'
        required: false
        default: 'shadowsocks-rust'

env:
  GHCR_REGISTRY: ghcr.io
  GHCR_IMAGE_BASE: ghcr.io/${{ github.repository_owner }}

jobs:
  test-tag-matching:
    runs-on: ubuntu-latest
    steps:
      - name: Check inputs
        run: |
          echo "Testing version: ${{ github.event.inputs.version }}"
          echo "Testing repository: ${{ github.event.inputs.repo }}"
          echo "Repository owner: ${{ github.repository_owner }}"
          
      - name: Test tag matching logic
        run: |
          VERSION="${{ github.event.inputs.version }}"
          REPO="${{ github.event.inputs.repo }}"
          REPO_OWNER="${{ github.repository_owner }}"
          
          echo "=== Starting tag matching test ==="
          echo "Target: $REPO_OWNER/$REPO"
          echo "Version: $VERSION"
          
          MAX_RETRIES=3
          RETRY_DELAY=5
          
          for i in $(seq 1 $MAX_RETRIES); do
            echo ""
            echo "Attempt $i of $MAX_RETRIES: Fetching tags from $REPO..."
            
            # 获取token
            TOKEN=$(curl -fsSL "https://ghcr.io/token?scope=repository:$REPO_OWNER/$REPO:pull" | jq -r '.token // empty')
            
            if [ -n "$TOKEN" ]; then
              echo "✓ Token obtained successfully"
              
              # 获取所有标签
              echo "Fetching tags list from GHCR..."
              RESPONSE=$(curl -fsSL -H "Authorization: Bearer $TOKEN" \
                "https://ghcr.io/v2/$REPO_OWNER/$REPO/tags/list")
              
              # 检查响应
              echo "Response status: $(echo "$RESPONSE" | jq -r '.errors? // "success"')"
              
              ALL_TAGS=$(echo "$RESPONSE" | jq -r '.tags[]?' 2>/dev/null || echo "")
              
              if [ -n "$ALL_TAGS" ]; then
                TAG_COUNT=$(echo "$ALL_TAGS" | wc -l)
                echo "✓ Retrieved $TAG_COUNT tags from $REPO"
                
                echo ""
                echo "=== ALL TAGS (first 30) ==="
                echo "$ALL_TAGS" | head -30
                
                echo ""
                echo "=== TAGS CONTAINING '$VERSION' ==="
                CONTAINING_TAGS=$(echo "$ALL_TAGS" | grep "$VERSION" || echo "None")
                echo "$CONTAINING_TAGS"
                
                echo ""
                echo "=== EXACT MATCH TEST ==="
                
                # 根据仓库类型使用不同的匹配模式
                if [ "$REPO" = "shadowsocks-rust" ]; then
                  echo "Testing patterns for shadowsocks-rust:"
                  echo "Pattern: ^${VERSION}(-server|-client|-local)?(-debian|-alpine)?\$"
                  
                  MATCHING_TAGS=$(echo "$ALL_TAGS" | grep -E "^${VERSION}(-server|-client|-local)?(-debian|-alpine)?$" || echo "")
                else
                  echo "Testing patterns for $REPO:"
                  echo "Pattern: ^${VERSION}(-debian|-alpine)?\$"
                  
                  MATCHING_TAGS=$(echo "$ALL_TAGS" | grep -E "^${VERSION}(-debian|-alpine)?$" || echo "")
                fi
                
                if [ -n "$MATCHING_TAGS" ]; then
                  MATCH_COUNT=$(echo "$MATCHING_TAGS" | wc -l)
                  echo "✅ SUCCESS: Found $MATCH_COUNT exact matching tags!"
                  echo "Matching tags:"
                  echo "$MATCHING_TAGS"
                  
                  echo ""
                  echo "=== MATCHING TAG ANALYSIS ==="
                  while IFS= read -r TAG; do
                    if [ -n "$TAG" ]; then
                      echo "Tag: $TAG"
                      # 分析标签结构
                      if [[ "$TAG" =~ ^${VERSION}$ ]]; then
                        echo "  Type: Pure version (no suffix)"
                      elif [[ "$TAG" =~ ^${VERSION}-(server|client|local)$ ]]; then
                        echo "  Type: With variant only (${BASH_REMATCH[1]})"
                      elif [[ "$TAG" =~ ^${VERSION}-(server|client|local)-(debian|alpine)$ ]]; then
                        echo "  Type: With variant (${BASH_REMATCH[1]}) and base (${BASH_REMATCH[2]})"
                      elif [[ "$TAG" =~ ^${VERSION}-(debian|alpine)$ ]]; then
                        echo "  Type: With base only (${BASH_REMATCH[1]})"
                      else
                        echo "  Type: Unknown pattern"
                      fi
                    fi
                  done <<< "$MATCHING_TAGS"
                else
                  echo "❌ FAILURE: No exact matching tags found!"
                  
                  echo ""
                  echo "=== CLOSEST MATCHES ==="
                  # 找最接近的版本
                  echo "Looking for closest version matches..."
                  ALL_VERSIONS=$(echo "$ALL_TAGS" | grep -o 'v[0-9]\+\.[0-9]\+\.[0-9]\+' | sort -u -V)
                  echo "All unique versions found:"
                  echo "$ALL_VERSIONS"
                  
                  LATEST_FOUND=$(echo "$ALL_VERSIONS" | tail -1)
                  echo "Latest version found: $LATEST_FOUND"
                fi
                
                break  # 成功获取，退出重试循环
              else
                echo "⚠️ No tags found in $REPO"
                echo "Full response:"
                echo "$RESPONSE" | jq .
                break
              fi
            else
              echo "✗ Failed to get token for $REPO"
              if [ $i -lt $MAX_RETRIES ]; then
                echo "Retrying in ${RETRY_DELAY}s..."
                sleep $RETRY_DELAY
              else
                echo "Max retries reached"
              fi
            fi
          done
          
          echo ""
          echo "=== TEST COMPLETE ==="
          
      - name: Test regex patterns directly
        run: |
          echo ""
          echo "=== REGEX PATTERN TEST ==="
          echo "Testing regex patterns with sample tags..."
          
          # 测试主仓库的正则表达式
          echo ""
          echo "1. Testing shadowsocks-rust patterns:"
          echo "Pattern: ^v1.24.0(-server|-client|-local)?(-debian|-alpine)?\$"
          
          SAMPLE_TAGS="v1.24.0
v1.24.0-server
v1.24.0-client
v1.24.0-local
v1.24.0-server-debian
v1.24.0-client-debian
v1.24.0-local-debian
v1.24.0-server-alpine
v1.24.0-client-alpine
v1.24.0-local-alpine
latest
latest-server
v1.23.0
v1.24.0-extra
v1.24.0-server-extra"
          
          echo "Sample tags to test:"
          echo "$SAMPLE_TAGS"
          
          echo ""
          echo "Matching results:"
          while IFS= read -r TAG; do
            if [[ "$TAG" =~ ^v1.24.0(-server|-client|-local)?(-debian|-alpine)?$ ]]; then
              echo "✅ MATCH: $TAG"
            else
              echo "❌ NO MATCH: $TAG"
            fi
          done <<< "$SAMPLE_TAGS"
          
          echo ""
          echo "2. Testing specialized repo patterns:"
          echo "Pattern: ^v1.24.0(-debian|-alpine)?\$"
          
          echo "Matching results:"
          while IFS= read -r TAG; do
            if [[ "$TAG" =~ ^v1.24.0(-debian|-alpine)?$ ]]; then
              echo "✅ MATCH: $TAG"
            else
              echo "❌ NO MATCH: $TAG"
            fi
          done <<< "$SAMPLE_TAGS"
